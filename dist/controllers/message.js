"use strict";

const Conversation = require("../models/conversation");

const Message = require("../models/message");

const isNull = x => x === null ? [] : x;

exports.getMessages = (req, res, next) => {
  const {
    id
  } = req.params;
  Conversation.findByPk(id, {
    attributes: ["id", "userOneId", "userTwoId"]
  }).then(conversation => {
    if (!conversation) {
      return res.status(404).json({
        message: "Conversation not found"
      });
    }

    Message.findAll({
      where: {
        userId: conversation.userOneId,
        conversationId: conversation.id
      },
      raw: true
    }).then(userOneMessages => {
      Message.findAll({
        where: {
          userId: conversation.userTwoId,
          conversationId: conversation.id
        },
        raw: true
      }).then(userTwoMessages => {
        console.log(userOneMessages, userTwoMessages);
        const combinedMessages = [].concat(isNull(userOneMessages), isNull(userTwoMessages));
        const filteredMessages = combinedMessages.sort((a, b) => {
          return new Date(a.creaetedAt) - new Date(b.creaetedAt);
        });
        res.status(200).json({
          messages: filteredMessages
        });
      });
    });
  }).catch(err => {
    const error = new Error(err);
    error.httpStatusCode = 500;
    return next(error);
  });
};

exports.postCreateMessage = (req, res, next) => {
  const {
    userId,
    conversationId,
    text
  } = req.body;

  if (!text) {
    res.status(403).json({
      message: "Message could not be empty"
    });
  }

  Message.create({
    userId: userId,
    conversationId: conversationId,
    text: text
  }).then(result => {
    res.status(201).json({
      id: result.toJSON().id,
      userId: userId,
      conversationId: conversationId,
      text: result.toJSON().text,
      createdAt: result.toJSON().createdAt
    });
  }).catch(err => {
    const error = new Error(err);
    error.httpStatusCode = 500;
    return next(error);
  });
};

exports.putUpdateMessage = (req, res, next) => {
  const {
    messageId,
    text
  } = req.body;
  Message.findByPk(messageId).then(message => {
    message.text = text;
    message.save();
    return message.toJSON();
  }).then(message => {
    res.status(201).json(message);
  }).catch(err => {
    const error = new Error(err);
    error.httpStatusCode = 500;
    return next(error);
  });
};

exports.deleteMessage = (req, res, next) => {
  const {
    messageId
  } = req.body;
  Message.findByPk(messageId).then(message => {
    const deletedMessage = {
      messageId: message.id,
      conversationId: message.conversationId
    };
    message.destroy();
    return deletedMessage;
  }).then(deletedMessage => {
    res.status(200).json({ ...deletedMessage,
      message: "Message was deleted"
    });
  }).catch(err => {
    const error = new Error(err);
    error.httpStatusCode = 500;
    return next(error);
  });
};
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9jb250cm9sbGVycy9tZXNzYWdlLmpzIl0sIm5hbWVzIjpbIkNvbnZlcnNhdGlvbiIsInJlcXVpcmUiLCJNZXNzYWdlIiwiaXNOdWxsIiwieCIsImV4cG9ydHMiLCJnZXRNZXNzYWdlcyIsInJlcSIsInJlcyIsIm5leHQiLCJpZCIsInBhcmFtcyIsImZpbmRCeVBrIiwiYXR0cmlidXRlcyIsInRoZW4iLCJjb252ZXJzYXRpb24iLCJzdGF0dXMiLCJqc29uIiwibWVzc2FnZSIsImZpbmRBbGwiLCJ3aGVyZSIsInVzZXJJZCIsInVzZXJPbmVJZCIsImNvbnZlcnNhdGlvbklkIiwicmF3IiwidXNlck9uZU1lc3NhZ2VzIiwidXNlclR3b0lkIiwidXNlclR3b01lc3NhZ2VzIiwiY29uc29sZSIsImxvZyIsImNvbWJpbmVkTWVzc2FnZXMiLCJjb25jYXQiLCJmaWx0ZXJlZE1lc3NhZ2VzIiwic29ydCIsImEiLCJiIiwiRGF0ZSIsImNyZWFldGVkQXQiLCJtZXNzYWdlcyIsImNhdGNoIiwiZXJyIiwiZXJyb3IiLCJFcnJvciIsImh0dHBTdGF0dXNDb2RlIiwicG9zdENyZWF0ZU1lc3NhZ2UiLCJ0ZXh0IiwiYm9keSIsImNyZWF0ZSIsInJlc3VsdCIsInRvSlNPTiIsImNyZWF0ZWRBdCIsInB1dFVwZGF0ZU1lc3NhZ2UiLCJtZXNzYWdlSWQiLCJzYXZlIiwiZGVsZXRlTWVzc2FnZSIsImRlbGV0ZWRNZXNzYWdlIiwiZGVzdHJveSJdLCJtYXBwaW5ncyI6Ijs7QUFBQSxNQUFNQSxZQUFZLEdBQUdDLE9BQU8sQ0FBQyx3QkFBRCxDQUE1Qjs7QUFDQSxNQUFNQyxPQUFPLEdBQUdELE9BQU8sQ0FBQyxtQkFBRCxDQUF2Qjs7QUFFQSxNQUFNRSxNQUFNLEdBQUdDLENBQUMsSUFBS0EsQ0FBQyxLQUFLLElBQU4sR0FBYSxFQUFiLEdBQWtCQSxDQUF2Qzs7QUFFQUMsT0FBTyxDQUFDQyxXQUFSLEdBQXNCLENBQUNDLEdBQUQsRUFBTUMsR0FBTixFQUFXQyxJ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b25zdCBDb252ZXJzYXRpb24gPSByZXF1aXJlKFwiLi4vbW9kZWxzL2NvbnZlcnNhdGlvblwiKTtcbmNvbnN0IE1lc3NhZ2UgPSByZXF1aXJlKFwiLi4vbW9kZWxzL21lc3NhZ2VcIik7XG5cbmNvbnN0IGlzTnVsbCA9IHggPT4gKHggPT09IG51bGwgPyBbXSA6IHgpO1xuXG5leHBvcnRzLmdldE1lc3NhZ2VzID0gKHJlcSwgcmVzLCBuZXh0KSA9PiB7XG4gIGNvbnN0IHsgaWQgfSA9IHJlcS5wYXJhbXM7XG5cbiAgQ29udmVyc2F0aW9uLmZpbmRCeVBrKGlkLCB7IGF0dHJpYnV0ZXM6IFtcImlkXCIsIFwidXNlck9uZUlkXCIsIFwidXNlclR3b0lkXCJdIH0pXG4gICAgLnRoZW4oY29udmVyc2F0aW9uID0+IHtcbiAgICAgIGlmICghY29udmVyc2F0aW9uKSB7XG4gICAgICAgIHJldHVybiByZXMuc3RhdHVzKDQwNCkuanNvbih7IG1lc3NhZ2U6IFwiQ29udmVyc2F0aW9uIG5vdCBmb3VuZFwiIH0pO1xuICAgICAgfVxuXG4gICAgICBNZXNzYWdlLmZpbmRBbGwoe1xuICAgICAgICB3aGVyZToge1xuICAgICAgICAgIHVzZXJJZDogY29udmVyc2F0aW9uLnVzZXJPbmVJZCxcbiAgICAgICAgICBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uLmlkXG4gICAgICAgIH0sXG4gICAgICAgIHJhdzogdHJ1ZVxuICAgICAgfSkudGhlbih1c2VyT25lTWVzc2FnZXMgPT4ge1xuICAgICAgICBNZXNzYWdlLmZpbmRBbGwoe1xuICAgICAgICAgIHdoZXJlOiB7XG4gICAgICAgICAgICB1c2VySWQ6IGNvbnZlcnNhdGlvbi51c2VyVHdvSWQsXG4gICAgICAgICAgICBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uLmlkXG4gICAgICAgICAgfSxcbiAgICAgICAgICByYXc6IHRydWVcbiAgICAgICAgfSkudGhlbih1c2VyVHdvTWVzc2FnZXMgPT4ge1xuICAgICAgICAgIGNvbnNvbGUubG9nKHVzZXJPbmVNZXNzYWdlcywgdXNlclR3b01lc3NhZ2VzKTtcblxuICAgICAgICAgIGNvbnN0IGNvbWJpbmVkTWVzc2FnZXMgPSBbXS5jb25jYXQoXG4gICAgICAgICAgICBpc051bGwodXNlck9uZU1lc3NhZ2VzKSxcbiAgICAgICAgICAgIGlzTnVsbCh1c2VyVHdvTWVzc2FnZXMpXG4gICAgICAgICAgKTtcblxuICAgICAgICAgIGNvbnN0IGZpbHRlcmVkTWVzc2FnZXMgPSBjb21iaW5lZE1lc3NhZ2VzLnNvcnQoKGEsIGIpID0+IHtcbiAgICAgICAgICAgIHJldHVybiBuZXcgRGF0ZShhLmNyZWFldGVkQXQpIC0gbmV3IERhdGUoYi5jcmVhZXRlZEF0KTtcbiAgICAgICAgICB9KTtcblxuICAgICAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgICAgIG1lc3NhZ2VzOiBmaWx0ZXJlZE1lc3NhZ2VzXG4gICAgICAgICAgfSk7XG4gICAgICAgIH0pO1xuICAgICAgfSk7XG4gICAgfSlcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKGVycik7XG4gICAgICBlcnJvci5odHRwU3RhdHVzQ29kZSA9IDUwMDtcbiAgICAgIHJldHVybiBuZXh0KGVycm9yKTtcbiAgICB9KTtcbn07XG5cbmV4cG9ydHMucG9zdENyZWF0ZU1lc3NhZ2UgPSAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgY29uc3QgeyB1c2VySWQsIGNvbnZlcnNhdGlvbklkLCB0ZXh0IH0gPSByZXEuYm9keTtcblxuICBpZiAoIXRleHQpIHtcbiAgICByZXMuc3RhdHVzKDQwMykuanNvbih7XG4gICAgICBtZXNzYWdlOiBcIk1lc3NhZ2UgY291bGQgbm90IGJlIGVtcHR5XCJcbiAgICB9KTtcbiAgfVxuXG4gIE1lc3NhZ2UuY3JlYXRlKHtcbiAgICB1c2VySWQ6IHVzZXJJZCxcbiAgICBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uSWQsXG4gICAgdGV4dDogdGV4dFxuICB9KVxuICAgIC50aGVuKHJlc3VsdCA9PiB7XG4gICAgICByZXMuc3RhdHVzKDIwMSkuanNvbih7XG4gICAgICAgIGlkOiByZXN1bHQudG9KU09OKCkuaWQsXG4gICAgICAgIHVzZXJJZDogdXNlcklkLFxuICAgICAgICBjb252ZXJzYXRpb25JZDogY29udmVyc2F0aW9uSWQsXG4gICAgICAgIHRleHQ6IHJlc3VsdC50b0pTT04oKS50ZXh0LFxuICAgICAgICBjcmVhdGVkQXQ6IHJlc3VsdC50b0pTT04oKS5jcmVhdGVkQXRcbiAgICAgIH0pO1xuICAgIH0pXG4gICAgLmNhdGNoKGVyciA9PiB7XG4gICAgICBjb25zdCBlcnJvciA9IG5ldyBFcnJvcihlcnIpO1xuICAgICAgZXJyb3IuaHR0cFN0YXR1c0NvZGUgPSA1MDA7XG4gICAgICByZXR1cm4gbmV4dChlcnJvcik7XG4gICAgfSk7XG59O1xuXG5leHBvcnRzLnB1dFVwZGF0ZU1lc3NhZ2UgPSAocmVxLCByZXMsIG5leHQpID0+IHtcbiAgY29uc3QgeyBtZXNzYWdlSWQsIHRleHQgfSA9IHJlcS5ib2R5O1xuXG4gIE1lc3NhZ2UuZmluZEJ5UGsobWVzc2FnZUlkKVxuICAgIC50aGVuKG1lc3NhZ2UgPT4ge1xuICAgICAgbWVzc2FnZS50ZXh0ID0gdGV4dDtcbiAgICAgIG1lc3NhZ2Uuc2F2ZSgpO1xuXG4gICAgICByZXR1cm4gbWVzc2FnZS50b0pTT04oKTtcbiAgICB9KVxuICAgIC50aGVuKG1lc3NhZ2UgPT4ge1xuICAgICAgcmVzLnN0YXR1cygyMDEpLmpzb24obWVzc2FnZSk7XG4gICAgfSlcbiAgICAuY2F0Y2goZXJyID0+IHtcbiAgICAgIGNvbnN0IGVycm9yID0gbmV3IEVycm9yKGVycik7XG4gICAgICBlcnJvci5odHRwU3RhdHVzQ29kZSA9IDUwMDtcbiAgICAgIHJldHVybiBuZXh0KGVycm9yKTtcbiAgICB9KTtcbn07XG5cbmV4cG9ydHMuZGVsZXRlTWVzc2FnZSA9IChyZXEsIHJlcywgbmV4dCkgPT4ge1xuICBjb25zdCB7IG1lc3NhZ2VJZCB9ID0gcmVxLmJvZHk7XG5cbiAgTWVzc2FnZS5maW5kQnlQayhtZXNzYWdlSWQpXG4gICAgLnRoZW4obWVzc2FnZSA9PiB7XG4gICAgICBjb25zdCBkZWxldGVkTWVzc2FnZSA9IHtcbiAgICAgICAgbWVzc2FnZUlkOiBtZXNzYWdlLmlkLFxuICAgICAgICBjb252ZXJzYXRpb25JZDogbWVzc2FnZS5jb252ZXJzYXRpb25JZFxuICAgICAgfTtcblxuICAgICAgbWVzc2FnZS5kZXN0cm95KCk7XG5cbiAgICAgIHJldHVybiBkZWxldGVkTWVzc2FnZTtcbiAgICB9KVxuICAgIC50aGVuKGRlbGV0ZWRNZXNzYWdlID0+IHtcbiAgICAgIHJlcy5zdGF0dXMoMjAwKS5qc29uKHtcbiAgICAgICAgLi4uZGVsZXRlZE1lc3NhZ2UsXG4gICAgICAgIG1lc3NhZ2U6IFwiTWVzc2FnZSB3YXMgZGVsZXRlZFwiXG4gICAgICB9KTtcbiAgICB9KVxuICAgIC5jYXRjaChlcnIgPT4ge1xuICAgICAgY29uc3QgZXJyb3IgPSBuZXcgRXJyb3IoZXJyKTtcbiAgICAgIGVycm9yLmh0dHBTdGF0dXNDb2RlID0gNTAwO1xuICAgICAgcmV0dXJuIG5leHQoZXJyb3IpO1xuICAgIH0pO1xufTtcbiJdfQ==